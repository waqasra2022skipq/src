#!/usr/bin/perl
use strict;
use warnings;
use lib '/var/www/okmis/src/lib';
use DBI;
use myForm;
use myDBI;
use DBA;
use DBUtil;
use Time::Local;

my $DT    = localtime();
my $form  = myForm->new();
my $dbh   = myDBI->dbconnect( $form->{'DBNAME'} );
my $debug = $form->{'LOGINPROVID'} == 91 ? 0 : 0;

if ($debug) {
    foreach my $f ( sort keys %{$form} ) { print "form-$f=$form->{$f}\n"; }
}

$form = DBUtil->setDates($form);
my $DateRange = qq|from $form->{FromDateD} thru $form->{ToDateD}|;
my $multidel  = 'Ã½';
my $ForProvID = $form->{ForProvID} || $form->{LOGINPROVID};

my $withSelection = DBA->withSelection( $form, 'and', 'Client.clinicClinicID',
    'Treatment.ProvID', 'Treatment.ClientID', 'Treatment.TrID' );
my $Header = DBA->withSelectionHeader($form);
$withSelection .= qq| and Client.Active=1| if ( $form->{Active} );

my $QID = qq|QID128|;
my $TITLE =
qq|Preventive Care and Screening: Body Mass Index (BMI) Screening and Follow-Up Plan - National Quality Strategy Domain: Community/Population Health - Meaningful Measure Area: Preventive Care|;
my $CTYPE = qq|MIPS CLINICAL QUALITY MEASURES (CQMS)|;
my $MTYPE = qq|Process|;
my $DESC =
qq|Percentage of patients aged 18 years and older with a BMI documented during 
the current encounter or within the previous twelve months AND who had a follow-up 
plan documented if most recent BMI was outside of normal parameters|;

my @FLDS = (
    "ProvID:ProvID",
    "Provider Name:Provider Name",
    "total_pop:Total Population",
    "denom:denominator",
    "G9996:DNOM Excluded(G9996)",
    "G8420:Performance Met(G8420)",
    "G8421:Performance Not Met(G8421)",
    "Data Completeness Rate:Data Completeness Rate",
    "Performance Rate:Performance Rate"
);

my $numFLDS = scalar(@FLDS) - 2;
print qq|numFLDS=${numFLDS}\n| if ($debug);

my $ClientSelection =
  DBA->withSelection( $form, 'and', 'Client.clinicClinicID', 'Client.ProvID' );

my $sClient = $dbh->prepare(
    "SELECT Client.*, ClientVitalSigns.*, 
ClientEmergency.HospiceCheck, Client.LName, Client.FName, Client.ClientID, Clinic.Name as ClinicName, 
CONCAT(Counselor.LName, ', ', Counselor.FName) as PrimaryProvider, xRaces.Descr as Race, Client.DOB, 
TIMESTAMPDIFF(YEAR, Client.DOB, CURDATE()) AS Age, count(*) as pcount 
FROM Client LEFT JOIN ClientEmergency ON Client.ClientID=ClientEmergency.ClientID 
LEFT JOIN Provider as Counselor ON Counselor.ProvID = Client.ProvID 
LEFT JOIN okmis_config.xRaces ON xRaces.ID = SUBSTRING_INDEX(Client.Race, '${multidel}', 1) 
LEFT JOIN ClientVitalSigns ON ClientVitalSigns.ClientID=Client.ClientID 
LEFT JOIN Provider as Clinic ON Clinic.ProvID = Client.clinicClinicID 
WHERE Client.ClientID>100 ${ClientSelection} AND 
Client.ProvID IN ('2118', '2128', '2686', '958')"
);

my $sInsurance = $dbh->prepare(
"SELECT * FROM Insurance WHERE ClientID=? AND InsID=212 AND InsNumActive=1 ORDER BY InsNumEffDate DESC"
);

my ( $Denominator, $total, $PFMET, $DNEXCEPTION, $PFNOTMET, $DNEXCLUDED ) =
  ( 0, 0, 0, 0, 0, 0 );

my $table_header = qq|\n|;
foreach my $f (@FLDS) {
    my ( $fld, $hdr ) = split( ':', $f );
    $table_header .= qq|${hdr}\t|;
}
$table_header .= qq|\n|;
my $table_entries = '';

$form = DBUtil->setDates($form);

my $qTreatment =
qq|SELECT * FROM Treatment LEFT JOIN xSC ON xSC.SCID = Treatment.SCID WHERE Treatment.ClientID = ? AND (Treatment.ContLogDate >= '$form->{FromDate}' AND Treatment.ContLogDate <= '$form->{ToDate}') AND (xSC.SCNum = '90791' OR xSC.SCNum = '90792' OR xSC.SCNum = '90832' OR xSC.SCNum = '90834' OR xSC.SCNum = '90837' OR xSC.SCNum = '96156' OR xSC.SCNum = '96158' OR xSC.SCNum = '97161' OR xSC.SCNum = '97162' OR xSC.SCNum = '97163' OR xSC.SCNum = '97165' OR xSC.SCNum = '97166' OR xSC.SCNum = '97167' OR xSC.SCNum = '97802' OR xSC.SCNum = '97803' OR xSC.SCNum = '99202' OR xSC.SCNum = '99203' OR xSC.SCNum = '99204' OR xSC.SCNum = '99205' OR xSC.SCNum = '99212' OR xSC.SCNum = '99213' OR xSC.SCNum = '99214' OR xSC.SCNum = '99215' OR xSC.SCNum = '99236' OR xSC.SCNum = '99304' OR xSC.SCNum = '99305' OR xSC.SCNum = '99306' OR xSC.SCNum = '99307' OR xSC.SCNum = '99308' OR xSC.SCNum = '99309' OR xSC.SCNum = '99310' OR xSC.SCNum = '99315' OR xSC.SCNum = '99316' OR xSC.SCNum = '99318' OR xSC.SCNum = '99324' OR xSC.SCNum = '99325' OR xSC.SCNum = '99326' OR xSC.SCNum = '99327' OR xSC.SCNum = '99328' OR xSC.SCNum = '99334' OR xSC.SCNum = '99335' OR xSC.SCNum = '99336' OR xSC.SCNum = '99337' OR xSC.SCNum = '99339' OR xSC.SCNum = '99340' OR xSC.SCNum LIKE '99385%' OR xSC.SCNum LIKE '99386%' OR xSC.SCNum LIKE '99387%' OR xSC.SCNum LIKE '99395%' OR xSC.SCNum LIKE '99396%' OR xSC.SCNum LIKE '99397%' OR xSC.SCNum LIKE '99401%' OR xSC.SCNum LIKE '99402%' OR xSC.SCNum = 'G0101' OR xSC.SCNum = 'G0108' OR xSC.SCNum = 'G0270' OR xSC.SCNum = 'G0271' OR xSC.SCNum = 'G0402' OR xSC.SCNum = 'G0438' OR xSC.SCNum = 'G0439' OR xSC.SCNum = 'G0447' OR xSC.SCNum = 'G0473' OR xSC.SCNum = 'D7111' OR xSC.SCNum = 'D7140' OR xSC.SCNum = 'D7210' OR xSC.SCNum = 'D7220' OR xSC.SCNum = 'D7230' OR xSC.SCNum = 'D7240' OR xSC.SCNum = 'D7241' OR xSC.SCNum = 'D7250' OR xSC.SCNum = 'D7251')|;

my $sClientVitalSigns = $dbh->prepare(
    "SELECT * FROM ClientVitalSigns WHERE ClientID=? ORDER BY VDate LIMIT 1");

our %providers = (
    "2118" =>
      { 'name' => "Kizzy McCaskill", "G9996" => 0, "G8420" => 0, "G8421" => 0 },
    "2128" =>
      { 'name' => "Rebecca Jones L", "G9996" => 0, "G8420" => 0, "G8421" => 0 },
    "2686" =>
      { 'name' => "Shelby Lucas", "G9996" => 0, "G8420" => 0, "G8421" => 0 },
    "958" =>
      { 'name' => "Mindy Jones K", "G9996" => 0, "G8420" => 0, "G8421" => 0 }
);

our %providers_rates = (
    "2118" => {
        'name'        => "Kizzy McCaskill",
        "total_pop"   => 0,
        "PFMET"       => 0,
        "PFNOTMET"    => 0,
        "initial_pop" => 0
    },
    "2128" => {
        'name'        => "Rebecca Jones L",
        "total_pop"   => 0,
        "PFMET"       => 0,
        "PFNOTMET"    => 0,
        "initial_pop" => 0
    },
    "2686" => {
        'name'        => "Shelby Lucas",
        "total_pop"   => 0,
        "PFMET"       => 0,
        "PFNOTMET"    => 0,
        "initial_pop" => 0
    },
    "958" => {
        'name'        => "Mindy Jones K",
        "total_pop"   => 0,
        "PFMET"       => 0,
        "PFNOTMET"    => 0,
        "initial_pop" => 0
    }
);

$sClient->execute();
my $total_patients = 0;
my $ProvID;
my @missingVitals = ();

while ( my $rClient = $sClient->fetchrow_hashref ) {
    $ProvID = $rClient->{'ProvID'};

    my $sTreatment = $dbh->prepare($qTreatment);
    $sTreatment->execute( $rClient->{ClientID} );
    my $rTreatment = $sTreatment->fetchrow_hashref;
    next unless $rTreatment;

    $providers_rates{$ProvID}{'initial_pop'} += 1;
    $sInsurance->execute( $rClient->{ClientID} )
      || $form->dberror("select Insurance $rClient->{ClientID}");

    my $rInsurance = $sInsurance->fetchrow_hashref;
    next unless $rInsurance;

    $providers_rates{$ProvID}{'total_pop'} += 1;

    if ( $rClient->{'HospiceCheck'} eq 1 ) {
        $DNEXCLUDED++;
        $providers_rates{$ProvID}{'DNEXCLUDED'} += 1;
        $providers{$ProvID}{'G9996'}            += 1;
    }
    else {
        my $ClientID = $rClient->{'ClientID'};
        $sClientVitalSigns->execute($ClientID);
        my $rClientVitalSigns = $sClientVitalSigns->fetchrow_hashref;
        my $BMI               = $rClientVitalSigns->{BMI};
        my $HeightFeet        = $rClientVitalSigns->{HeightFeet};
        my $Weight            = $rClientVitalSigns->{Weight};

        if ( !$rClientVitalSigns ) {
            $PFNOTMET++;
            $providers_rates{$ProvID}{'PFNOTMET'} += 1;
            $providers{$ProvID}{'G8421'}          += 1;
        }
        else {
            if ( $BMI ne "" || ( $HeightFeet && $Weight ) ) {
                $PFMET++;
                $providers_rates{$ProvID}{'PFMET'} += 1;
                $providers{$ProvID}{'G8420'}       += 1;
            }
            else {
                $PFNOTMET++;
                $providers_rates{$ProvID}{'PFNOTMET'} += 1;
                $providers{$ProvID}{'G8421'}          += 1;
            }
        }
    }
}

foreach my $ProvID ( sort keys %providers ) {
    $table_entries .= qq|$ProvID\t|;

    my $provName = $providers{$ProvID}{'name'};
    $table_entries .= qq|$provName\t|;
    my $initial_pop = $providers_rates{$ProvID}{'initial_pop'};
    $table_entries .= qq|$initial_pop\t|;
    my $total_pop = $providers_rates{$ProvID}{'total_pop'};
    $table_entries .= qq|$total_pop\t|;

    my $G9996 = $providers{$ProvID}{'G9996'};
    $table_entries .= qq|$G9996\t|;
    my $G8420 = $providers{$ProvID}{'G8420'};
    $table_entries .= qq|$G8420\t|;
    my $G8421 = $providers{$ProvID}{'G8421'};
    $table_entries .= qq|$G8421\t|;

    my $pr_PFMET    = $providers_rates{$ProvID}{'PFMET'};
    my $pr_PFNOTMET = $providers_rates{$ProvID}{'PFNOTMET'};
    my $DNEXCLUDED  = $providers_rates{$ProvID}{'DNEXCLUDED'};

    my $Data_Completeness_Numerator =
      ( $pr_PFMET + $pr_PFNOTMET + $DNEXCLUDED );
    my $Data_Completeness_Rate =
      ( $Data_Completeness_Numerator / $total_pop ) * 100;
    my $Performance_Rate =
        ( $Data_Completeness_Numerator > $DNEXCLUDED )
      ? ( $pr_PFMET / ( $Data_Completeness_Numerator - $DNEXCLUDED ) ) * 100
      : 0;

    $Data_Completeness_Rate = sprintf( "%.2f", $Data_Completeness_Rate );
    $Performance_Rate       = sprintf( "%.2f", $Performance_Rate );

    $table_entries .= qq|$Data_Completeness_Rate\t|;
    $table_entries .= qq|$Performance_Rate\t|;
    $table_entries .= qq|\n|;
}

$Header = qq|${DT}\n${QID} ${TITLE} ${DateRange} ${Header}|;

print $Header;
print $table_header;
print $table_entries;

$sClientVitalSigns->finish();
$sClient->finish();
$sInsurance->finish();
myDBI->cleanup();
exit;
